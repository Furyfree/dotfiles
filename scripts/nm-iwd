#!/bin/bash
set -euo pipefail

nm_iwd() {
    local backend
    backend=$(detect_backend)
    echo "Active backend: $backend"  # DEBUG

    if [[ "$backend" == "nm-iwd" ]]; then
        echo "NetworkManager with iwd is already active"
    else
        echo "Switching to NetworkManager with iwd..."

        echo "Installing dependencies..."
        sudo pacman -S --needed networkmanager iwd --noconfirm
        echo "Done installing."

        echo "Disabling wpa_supplicant + systemd-networkd"
        sudo systemctl disable --now wpa_supplicant.service systemd-networkd.service systemd-networkd-wait-online.service systemd-networkd.socket systemd-networkd-varlink.socket || true
        sudo systemctl mask wpa_supplicant.service || true

        echo "Unmasking + enabling iwd"
        sudo systemctl unmask iwd.service || true
        sudo systemctl enable --now iwd.service

        echo "Writing NetworkManager config"
        sudo install -d /etc/NetworkManager/conf.d
        sudo sh -c 'cat > /etc/NetworkManager/NetworkManager.conf' <<EOF
[main]
plugins=keyfile
dns=systemd-resolved
rc-manager=symlink
EOF
        sudo sh -c 'cat > /etc/NetworkManager/conf.d/wifi_backend.conf' <<EOF
[device]
wifi.backend=iwd
EOF

        echo "Enabling + restarting NetworkManager"
        sudo systemctl enable --now NetworkManager.service
        sudo systemctl restart NetworkManager.service
    fi

    rfkill unblock wifi || true
    nmcli networking on >/dev/null 2>&1 || true
    nmcli radio wifi on >/dev/null 2>&1 || true

    if systemctl is-active --quiet iwd; then
        echo "iwd: active"
    else
        echo "iwd: not active but should be active"
    fi

    if systemctl is-active --quiet systemd-networkd; then
        echo "systemd-networkd: active but should not be active"
    else
        echo "systemd-networkd: not active"
    fi

    if systemctl is-active --quiet wpa_supplicant; then
        echo "wpa_supplicant: active but should not be active"
    else
        echo "wpa_supplicant: not active"
    fi

    if systemctl is-active --quiet NetworkManager; then
        echo "NetworkManager: active"
    else
        echo "NetworkManager: not active but should be active"
    fi

    # Validation
    if systemctl is-active --quiet iwd &&
        systemctl is-active --quiet NetworkManager &&
        systemctl is-active --quiet systemd-resolved &&
        ! systemctl is-active --quiet wpa_supplicant &&
        ! systemctl is-active --quiet systemd-networkd; then
        echo "Netstack is now nm-iwd"
        echo "Verification: $(detect_backend)"
        resolvectl status | sed -n '1,8p' || true
    else
        echo "Netstack validation failed"
    fi
}

detect_backend() {
    if systemctl is-active --quiet NetworkManager; then
        if systemctl is-active --quiet iwd; then
            if systemctl is-active --quiet systemd-networkd; then
                echo "systemd-iwd"
            else
                echo "nm-iwd"
            fi
        else
            echo "nm-wpa"
        fi
    elif systemctl is-active --quiet iwd && systemctl is-active --quiet systemd-networkd; then
        echo "systemd-iwd"
    else
        echo "none"
    fi
}
nm_iwd
