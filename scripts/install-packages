#!/bin/bash

# install-packages.sh: Install packages from packages folder
# Usage: ./install-packages.sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
PACKAGES_DIR="$DOTFILES_DIR/linux/packages"

# Check if packages directory exists
if [[ ! -d "$PACKAGES_DIR" ]]; then
    print_error "Packages directory not found at $PACKAGES_DIR"
    exit 1
fi

# Check if paru is installed
if ! command -v paru &>/dev/null; then
    print_error "paru is not installed. Please install paru first."
    exit 1
fi

print_step "Installing packages from packages folder..."

# Install packages from each category
for package_file in "$PACKAGES_DIR"/*.txt; do
    if [[ -f "$package_file" ]]; then
        filename="$(basename "$package_file")"
        category="${filename%.txt}"

        print_step "Processing $category packages..."

        # Read packages from file, excluding comments and empty lines
        packages=()
        while IFS= read -r line; do
            # Skip empty lines and comments
            if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
                packages+=("$line")
            fi
        done < "$package_file"

        if [[ ${#packages[@]} -eq 0 ]]; then
            print_warning "No packages found in $filename"
            continue
        fi

        print_step "Installing ${#packages[@]} packages from $category..."

        # Install packages with paru
        if paru -S --needed --noconfirm "${packages[@]}"; then
            print_success "$category packages installed successfully"
        else
            print_error "Some packages in $category failed to install"
            # Continue with other categories instead of exiting
        fi
    fi
done



print_success "Package installation completed!"
echo -e "${WHITE}All packages from the packages folder have been processed.${NC}"
